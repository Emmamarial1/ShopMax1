<!DOCTYPE html>
<html>
<head>
    <title>ShopMax Delivery App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 20px; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center; font-weight: bold; }
        .status.assigned { background: #fff3cd; color: #856404; }
        .status.picked_up { background: #d1ecf1; color: #0c5460; }
        .status.in_transit { background: #cce5ff; color: #004085; }
        .status.delivered { background: #d4edda; color: #155724; }
        .btn { display: block; width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .location-info { background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>üõµ ShopMax Delivery</h2>
            <p>Hello, {{ delivery_person.name }}!</p>
        </div>

        <div class="status {{ delivery.status }}">
            Current Status: {{ delivery.status|replace('_', ' ')|title }}
        </div>

        <div class="location-info" id="locationInfo">
            <strong>üìç Current Location:</strong><br>
            <span id="currentLocation">Getting location...</span>
        </div>

        {% if delivery.status == 'assigned' %}
        <button class="btn btn-primary" onclick="updateStatus('picked_up')">
            üì¶ Mark as Picked Up
        </button>
        {% elif delivery.status == 'picked_up' %}
        <button class="btn btn-warning" onclick="updateStatus('in_transit')">
            üöö Start Delivery
        </button>
        {% elif delivery.status == 'in_transit' %}
        <button class="btn btn-success" onclick="updateStatus('delivered')">
            ‚úÖ Mark as Delivered
        </button>
        {% endif %}

        <button class="btn" style="background: #6c757d; color: white;" onclick="shareLocation()">
            üìç Update Location
        </button>

        <div class="order-info">
            <h4>Order Details</h4>
            <p><strong>Order ID:</strong> #{{ delivery.order.id }}</p>
            <p><strong>Customer:</strong> {{ delivery.order.buyer.fullname if delivery.order.buyer else 'Guest' }}</p>
            <p><strong>Total:</strong> ‚Ç¶{{ "{:,.0f}".format(delivery.order.total_amount) if delivery.order.total_amount else 0 }}</p>
        </div>
    </div>

    <script>
        let deliveryId = {{ delivery.id }};
        let watchId;

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    updateLocation,
                    showError,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
                
                // Watch position for continuous updates
                watchId = navigator.geolocation.watchPosition(updateLocation, showError, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            } else {
                document.getElementById('locationInfo').innerHTML = 
                    'Geolocation is not supported by this browser.';
            }
        }

        function updateLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Get location name using reverse geocoding
            getLocationName(lat, lng).then(locationName => {
                document.getElementById('currentLocation').textContent = 
                    `${locationName} (${lat.toFixed(6)}, ${lng.toFixed(6)})`;
                
                // Send location to server
                fetch(`/api/delivery/${deliveryId}/update-location`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        latitude: lat,
                        longitude: lng,
                        location_name: locationName
                    })
                }).then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Failed to update location:', data.message);
                    }
                });
            });
        }

        async function getLocationName(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
                );
                const data = await response.json();
                
                if (data.display_name) {
                    return data.display_name.split(',')[0]; // Get first part of address
                }
            } catch (error) {
                console.error('Error getting location name:', error);
            }
            
            return `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
        }

        function showError(error) {
            let message = 'Unknown error';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location access denied by user';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location information unavailable';
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out';
                    break;
            }
            document.getElementById('currentLocation').textContent = message;
        }

        function updateStatus(newStatus) {
            if (confirm(`Are you sure you want to mark this delivery as "${newStatus.replace('_', ' ')}"?`)) {
                fetch(`/api/delivery/${deliveryId}/update-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    'X-CSRF-Token': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ status: newStatus })
                }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Status updated successfully!');
                        location.reload();
                    } else {
                        alert('Error updating status: ' + data.message);
                    }
                });
            }
        }

        function shareLocation() {
            getLocation();
            alert('Location updated!');
        }

        // Start location tracking when page loads
        getLocation();

        // Clean up when leaving page
        window.addEventListener('beforeunload', function() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });
    </script>
</body>
</html>