{% extends "base.html" %}

{% block title %}{{ category|title }} Products - ShopMax{% endblock %}

{% block content %}
<div class="products-page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>
                {% if category == 'all' %}
                    <i class="fas fa-shopping-bag"></i> All Products
                {% else %}
                    <i class="fas fa-tag"></i> {{ category|title }}
                {% endif %}
            </h1>
            <p class="page-subtitle">
                {% if category == 'all' %}
                    Discover amazing products from our trusted sellers
                {% else %}
                    Browse our curated collection of {{ category }} products
                {% endif %}
            </p>
        </div>
        <div class="header-stats">
            <span class="product-count">
                <i class="fas fa-box"></i> {{ items|length }} product{% if items|length != 1 %}s{% endif %}
            </span>
        </div>
    </div>

    <!-- Featured Sections -->
    {% if new_arrivals is defined or trending_products is defined %}
    <div class="featured-sections">
        <!-- New Arrivals Section -->
        {% if new_arrivals is defined %}
        <div class="featured-section new-arrivals">
            <div class="section-header">
                <h2><i class="fas fa-bolt"></i> New Arrivals</h2>
                <a href="{{ url_for('products') }}?sort=newest" class="view-all">View All <i class="fas fa-arrow-right"></i></a>
            </div>
            <div class="products-carousel">
                {% for product in new_arrivals %}
                <div class="product-card featured">
                    <div class="product-image">
                        <a href="{{ url_for('product_detail', product_id=product.id) }}">
                            {% if product.image %}
                                <img src="{{ url_for('static', filename='uploads/' + product.image) }}" 
                                     alt="{{ product.name }}"
                                     loading="lazy">
                            {% else %}
                                <div class="image-placeholder">
                                    <i class="fas fa-box"></i>
                                </div>
                            {% endif %}
                        </a>
                        <div class="new-badge">NEW</div>
                        <button class="wishlist-btn {% if product.id in wishlist_ids %}active{% endif %}" 
                                onclick="toggleWishlist(this, '{{ product.id }}')">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                    <div class="product-info">
                        <span class="product-category">{{ product.category|title }}</span>
                        <h3 class="product-name">
                            <a href="{{ url_for('product_detail', product_id=product.id) }}">
                                {{ product.name|truncate(25) }}
                            </a>
                        </h3>
                        <div class="product-price">UGX {{ "{:,.0f}".format(product.price) }}</div>
                        <div class="product-actions">
                            <a href="{{ url_for('product_detail', product_id=product.id) }}" class="view-details">
                                <i class="fas fa-eye"></i> View
                            </a>
                            {% if product.stock > 0 %}
                            <button class="add-to-cart" onclick="addToCart('{{ product.id }}')">
                                <i class="fas fa-shopping-cart"></i> Add
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if not new_arrivals %}
                <div class="empty-carousel">
                    <p>No new arrivals yet</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Trending Products Section -->
        {% if trending_products is defined %}
        <div class="featured-section trending-products">
            <div class="section-header">
                <h2><i class="fas fa-fire"></i> Trending Now</h2>
                <a href="{{ url_for('products') }}?sort=popular" class="view-all">View All <i class="fas fa-arrow-right"></i></a>
            </div>
            <div class="products-carousel">
                {% for product in trending_products %}
                <div class="product-card featured">
                    <div class="product-image">
                        <a href="{{ url_for('product_detail', product_id=product.id) }}">
                            {% if product.image %}
                                <img src="{{ url_for('static', filename='uploads/' + product.image) }}" 
                                     alt="{{ product.name }}"
                                     loading="lazy">
                            {% else %}
                                <div class="image-placeholder">
                                    <i class="fas fa-box"></i>
                                </div>
                            {% endif %}
                        </a>
                        <div class="trending-badge">
                            <i class="fas fa-fire"></i> HOT
                        </div>
                        <button class="wishlist-btn {% if product.id in wishlist_ids %}active{% endif %}" 
                                onclick="toggleWishlist(this, '{{ product.id }}')">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                    <div class="product-info">
                        <span class="product-category">{{ product.category|title }}</span>
                        <h3 class="product-name">
                            <a href="{{ url_for('product_detail', product_id=product.id) }}">
                                {{ product.name|truncate(25) }}
                            </a>
                        </h3>
                        <div class="product-meta">
                            <div class="product-rating">
                                <div class="stars">
                                    {% if product.reviews %}
                                    {% for i in range(5) %}
                                        {% if i < (product.reviews|length) %}
                                            <i class="fas fa-star"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                    {% else %}
                                    {% for i in range(5) %}
                                        <i class="far fa-star"></i>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                                <span class="review-count">
                                    <i class="fas fa-star"></i> {{ product.reviews|length if product.reviews else 0 }}
                                </span>
                            </div>
                        </div>
                        <div class="product-price">UGX {{ "{:,.0f}".format(product.price) }}</div>
                        <div class="product-actions">
                            <a href="{{ url_for('product_detail', product_id=product.id) }}" class="view-details">
                                <i class="fas fa-eye"></i> View
                            </a>
                            {% if product.stock > 0 %}
                            <button class="add-to-cart" onclick="addToCart('{{ product.id }}')">
                                <i class="fas fa-shopping-cart"></i> Add
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if not trending_products %}
                <div class="empty-carousel">
                    <p>No trending products yet</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- All Products Section -->
    {% if items %}
    <div class="all-products-section">
        <div class="section-header">
            <h2><i class="fas fa-th-large"></i> All Products</h2>
            <div class="sort-options">
                <select id="sortSelect" onchange="sortProducts()">
                    <option value="featured">Featured</option>
                    <option value="newest">Newest First</option>
                    <option value="price_low">Price: Low to High</option>
                    <option value="price_high">Price: High to Low</option>
                    <option value="popular">Most Popular</option>
                </select>
            </div>
        </div>
        
        <!-- Products Grid -->
        <div class="products-grid">
            {% for product in items %}
            <div class="product-card">
                <!-- Product Image -->
                <div class="product-image">
                    <a href="{{ url_for('product_detail', product_id=product.id) }}">
                        {% if product.image %}
                            <img src="{{ url_for('static', filename='uploads/' + product.image) }}" 
                                 alt="{{ product.name }}"
                                 loading="lazy">
                        {% else %}
                            <div class="image-placeholder">
                                <i class="fas fa-box"></i>
                            </div>
                        {% endif %}
                    </a>
                    
                    <!-- Stock Badge -->
                    <div class="stock-badge">
                        {% if product.stock > 5 %}
                            <span class="in-stock">In Stock</span>
                        {% elif product.stock > 0 %}
                            <span class="low-stock">{{ product.stock }} left</span>
                        {% else %}
                            <span class="out-stock">Out of Stock</span>
                        {% endif %}
                    </div>
                    
                    <!-- Wishlist Button -->
                    <button class="wishlist-btn {% if product.id in wishlist_ids %}active{% endif %}" 
                            onclick="toggleWishlist(this, '{{ product.id }}')"
                            title="{% if product.id in wishlist_ids %}Remove from Wishlist{% else %}Add to Wishlist{% endif %}">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>

                <!-- Product Info -->
                <div class="product-info">
                    <!-- Category -->
                    <span class="product-category">{{ product.category|title }}</span>
                    
                    <!-- Product Name -->
                    <h3 class="product-name">
                        <a href="{{ url_for('product_detail', product_id=product.id) }}">
                            {{ product.name|truncate(35) }}
                        </a>
                    </h3>
                    
                    <!-- Rating -->
                    {% if product.reviews and product.reviews|length > 0 %}
                    <div class="product-rating">
                        <div class="stars">
                            {% for i in range(5) %}
                                {% if i < (product.reviews|length) %}
                                    <i class="fas fa-star"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="rating-count">({{ product.reviews|length }})</span>
                    </div>
                    {% endif %}
                    
                    <!-- Seller -->
                    <div class="product-seller">
                        <i class="fas fa-store"></i>
                        {{ product.seller.business_name or product.seller.fullname|truncate(15) }}
                    </div>
                    
                    <!-- Price -->
                    <div class="product-price">UGX {{ "{:,.0f}".format(product.price) }}</div>
                    
                    <!-- Action Buttons -->
                    <div class="product-actions">
                        <a href="{{ url_for('product_detail', product_id=product.id) }}" class="view-details">
                            <i class="fas fa-eye"></i> View
                        </a>
                        
                        {% if product.stock > 0 %}
                        <button class="add-to-cart" onclick="addToCart('{{ product.id }}')">
                            <i class="fas fa-shopping-cart"></i> Add
                        </button>
                        {% else %}
                        <button class="out-of-stock" disabled>
                            <i class="fas fa-ban"></i> Sold Out
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- REMOVED Quick Stats Section -->
    
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-search"></i>
        </div>
        <h3>No Products Found</h3>
        <p>
            {% if category == 'all' %}
                No products are currently available in our marketplace.
            {% else %}
                No products found in the "{{ category }}" category.
            {% endif %}
        </p>
        <div class="empty-actions">
            <a href="{{ url_for('products') }}" class="btn-browse">
                <i class="fas fa-shopping-bag"></i> Browse All Products
            </a>
            {% if session.user_type == 'seller' %}
            <a href="{{ url_for('add_product') }}" class="btn-sell">
                <i class="fas fa-plus"></i> Start Selling
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
</div>

<style>
/* ===== Base Styles ===== */
.products-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1.5rem;
}

/* ===== Page Header ===== */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e9ecef;
}

.header-content h1 {
    color: #2c3e50;
    font-size: 1.8rem;
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.header-content h1 i {
    color: #3498db;
}

.page-subtitle {
    color: #dfe9f0; /* Blue color */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 1.1rem;
    font-weight: 500;
    margin: 0;
    line-height: 1.5;
    text-shadow: 0 1px 2px rgba(118, 209, 7, 0.1);
    transition: color 0.3s ease;
}

/* Optional hover effect */
.page-subtitle:hover { 
    color: #b2c529;
}

.header-stats {
    background: #f8f9fa;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.product-count {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #2c3e50;
    font-weight: 600;
    font-size: 0.95rem;
}

.product-count i {
    color: #3498db;
}

/* ===== Featured Sections ===== */
.featured-sections {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-bottom: 3rem;
}

.featured-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.section-header h2 {
    color: #2c3e50;
    font-size: 1.4rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-header h2 i {
    color: #e74c3c;
}

.view-all {
    color: #3498db;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.view-all:hover {
    color: #2980b9;
    gap: 0.75rem;
}

/* Products Carousel */
.products-carousel {
    display: flex;
    gap: 1.25rem;
    overflow-x: auto;
    padding: 0.5rem;
    scrollbar-width: thin;
    scrollbar-color: #3498db #f1f1f1;
}

.products-carousel::-webkit-scrollbar {
    height: 6px;
}

.products-carousel::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.products-carousel::-webkit-scrollbar-thumb {
    background: #3498db;
    border-radius: 3px;
}

/* Featured Product Card */
.product-card.featured {
    flex: 0 0 200px;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    height: 280px;
    display: flex;
    flex-direction: column;
}

.product-card.featured:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.12);
}

.product-card.featured .product-image {
    height: 130px;
    position: relative;
}

/* New Badge */
.new-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    background: #27ae60;
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Trending Badge */
.trending-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    background: #e74c3c;
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.product-card.featured .product-info {
    padding: 0.85rem;
}

.product-card.featured .product-name a {
    font-size: 0.9rem;
    height: 1.8rem;
}

.product-card.featured .product-price {
    font-size: 1rem;
    margin: 0.5rem 0;
}

.product-card.featured .product-actions {
    margin-top: 0.5rem;
}

.empty-carousel {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #7f8c8d;
    font-style: italic;
    min-height: 200px;
}

/* Product Meta for Trending */
.product-meta {
    margin: 0.5rem 0;
}

.product-meta .product-rating {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.review-count {
    color: #7f8c8d;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

/* ===== All Products Section ===== */
.all-products-section {
    margin-top: 2rem;
}

.sort-options select {
    padding: 0.5rem 1rem;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    background: white;
    color: #495057;
    font-size: 0.9rem;
    cursor: pointer;
}

.sort-options select:focus {
    outline: none;
    border-color: #3498db;
}

/* ===== Products Grid ===== */
.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.25rem;
    margin-bottom: 3rem;
}

/* ===== Product Card ===== */
.product-card {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    position: relative;
    height: 320px;
    display: flex;
    flex-direction: column;
}

.product-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.12);
}

/* Product Image */
.product-image {
    position: relative;
    height: 140px;
    overflow: hidden;
    background: #f8f9fa;
}

.product-image a {
    display: block;
    width: 100%;
    height: 100%;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.product-card:hover .product-image img {
    transform: scale(1.05);
}

.image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #bdc3c7;
    font-size: 2.5rem;
}

/* Stock Badge */
.stock-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    z-index: 2;
}

.stock-badge span {
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.in-stock {
    background: #d4edda;
    color: #155724;
}

.low-stock {
    background: #fff3cd;
    color: #856404;
}

.out-stock {
    background: #f8d7da;
    color: #721c24;
}

/* Wishlist Button */
.wishlist-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 32px;
    height: 32px;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #bdc3c7;
    transition: all 0.3s ease;
    z-index: 2;
    font-size: 0.9rem;
}

.wishlist-btn:hover {
    background: #fff5f5;
    border-color: #e74c3c;
    color: #e74c3c;
    transform: scale(1.1);
}

.wishlist-btn.active {
    background: #e74c3c;
    border-color: #e74c3c;
    color: white;
}

.wishlist-btn.active:hover {
    background: #c0392b;
    border-color: #c0392b;
}

/* Product Info */
.product-info {
    padding: 0.85rem;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.product-category {
    color: #3498db;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.35rem;
    display: inline-block;
}

.product-name {
    margin: 0 0 0.5rem 0;
    line-height: 1.2;
}

.product-name a {
    color: #2c3e50;
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: 600;
    transition: color 0.2s ease;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    height: 2.4rem;
}

.product-name a:hover {
    color: #3498db;
}

/* Product Rating */
.product-rating {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    margin-bottom: 0.5rem;
}

.stars {
    display: flex;
    gap: 0.05rem;
    color: #f39c12;
    font-size: 0.8rem;
}

.rating-count {
    color: #95a5a6;
    font-size: 0.75rem;
}

/* Product Seller */
.product-seller {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    color: #7f8c8d;
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #f1f1f1;
}

.product-seller i {
    color: #3498db;
    font-size: 0.7rem;
}

/* Product Price */
.product-price {
    color: #27ae60;
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
}

/* Product Actions */
.product-actions {
    margin-top: auto;
    display: flex;
    gap: 0.5rem;
}

.view-details, .add-to-cart, .out-of-stock {
    flex: 1;
    padding: 0.5rem;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.35rem;
    text-decoration: none;
}

.view-details {
    background: #f8f9fa;
    color: #495057;
    border: 1px solid #dee2e6;
}

.view-details:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.add-to-cart {
    background: #3498db;
    color: white;
}

.add-to-cart:hover {
    background: #2980b9;
    transform: translateY(-1px);
}

.out-of-stock {
    background: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
}

/* ===== Empty State ===== */
.empty-state {
    text-align: center;
    padding: 3rem 1.5rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
}

.empty-icon {
    font-size: 3.5rem;
    color: #bdc3c7;
    margin-bottom: 1.25rem;
}

.empty-state h3 {
    color: #2c3e50;
    margin-bottom: 0.65rem;
    font-size: 1.5rem;
}

.empty-state p {
    color: #7f8c8d;
    margin-bottom: 1.75rem;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
    font-size: 0.95rem;
}

.empty-actions {
    display: flex;
    gap: 0.85rem;
    justify-content: center;
    flex-wrap: wrap;
}

.btn-browse, .btn-sell {
    padding: 0.65rem 1.25rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.btn-browse {
    background: #3498db;
    color: white;
}

.btn-browse:hover {
    background: #2980b9;
    transform: translateY(-2px);
}

.btn-sell {
    background: white;
    color: #3498db;
    border: 2px solid #3498db;
}

.btn-sell:hover {
    background: #f8f9fa;
    transform: translateY(-2px);
}

/* ===== Loading Overlay ===== */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.loading-overlay.active {
    display: flex;
}

.spinner {
    width: 45px;
    height: 45px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ===== Toast Notifications ===== */
.toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 9998;
}

.toast {
    padding: 0.85rem 1.25rem;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    margin-bottom: 0.85rem;
    animation: slideIn 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.65rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    font-size: 0.9rem;
}

.toast.success {
    background: #27ae60;
}

.toast.error {
    background: #e74c3c;
}

.toast.info {
    background: #3498db;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* ===== Animations ===== */
@keyframes heartBeat {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.wishlist-btn.animate {
    animation: heartBeat 0.5s ease;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.cart-count.pulse {
    animation: pulse 0.5s ease-in-out;
}

/* ===== Responsive Design ===== */
@media (max-width: 1200px) {
    .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
    }
    
    .product-card.featured {
        flex: 0 0 180px;
    }
}

@media (max-width: 768px) {
    .products-page {
        padding: 1rem;
    }
    
    .page-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }
    
    .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 1rem;
    }
    
    .product-card {
        height: 300px;
    }
    
    .product-card.featured {
        flex: 0 0 160px;
        height: 260px;
    }
    
    .product-image {
        height: 130px;
    }
    
    .product-card.featured .product-image {
        height: 120px;
    }
    
    .section-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }
}

@media (max-width: 480px) {
    .products-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }
    
    .product-card {
        height: 290px;
    }
    
    .product-card.featured {
        flex: 0 0 140px;
        height: 250px;
    }
    
    .product-image {
        height: 120px;
    }
    
    .product-card.featured .product-image {
        height: 110px;
    }
    
    .product-info {
        padding: 0.75rem;
    }
    
    .product-name a {
        font-size: 0.9rem;
        height: 2.2rem;
    }
    
    .empty-actions {
        flex-direction: column;
    }
    
    .btn-browse, .btn-sell {
        width: 100%;
        justify-content: center;
    }
}
</style>
<script>
// Loading functions
function showLoading() {
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

// Toast notification
function showToast(message, type = 'info') {
    // Remove existing toasts
    const existingToasts = document.querySelectorAll('.toast');
    existingToasts.forEach(toast => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    });

    // Create new toast
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <i class="fas fa-${getToastIcon(type)}"></i>
        <span>${message}</span>
    `;
    
    // Create container if it doesn't exist
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }
    
    container.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
    
    return toast;
}

function getToastIcon(type) {
    const icons = {
        'success': 'check-circle',
        'error': 'exclamation-circle',
        'info': 'info-circle'
    };
    return icons[type] || 'info-circle';
}

function sortProducts() {
    const sortSelect = document.getElementById('sortSelect');
    const sortValue = sortSelect.value;
    showToast(`Sorted by: ${sortSelect.options[sortSelect.selectedIndex].text}`, 'info');
}

function toggleWishlist(button, productId) {
    button.classList.add('animate');
    setTimeout(() => button.classList.remove('animate'), 500);
    
    // Toggle active class
    const isActive = button.classList.contains('active');
    
    // Send AJAX request to update wishlist
    showLoading();
    fetch('/toggle_wishlist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ product_id: productId })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        hideLoading();
        if (data.success) {
            button.classList.toggle('active');
            showToast(
                data.message || (button.classList.contains('active') ? 'Added to wishlist!' : 'Removed from wishlist!'),
                'success'
            );
        } else {
            showToast(data.message || 'Failed to update wishlist', 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showToast('Something went wrong! Please try again.', 'error');
    });
}

function addToCart(productId) {
    showLoading();
    
    // Use the correct API endpoint from your routes
    fetch('/api/cart/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            product_id: productId, 
            quantity: 1 
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast(data.message || 'Added to cart successfully!', 'success');
            // Update cart count in navbar if exists
            updateCartCount(data.cart_count || 0);
        } else {
            showToast(data.message || 'Failed to add to cart', 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showToast('Something went wrong! Please try again.', 'error');
    });
}

function updateCartCount(count) {
    const cartCountElements = document.querySelectorAll('.cart-count');
    cartCountElements.forEach(cartCount => {
        cartCount.textContent = count;
        cartCount.classList.add('pulse');
        setTimeout(() => cartCount.classList.remove('pulse'), 500);
    });
}

// Function to update cart count on page load
function updateCartCountOnLoad() {
    // For logged-in users, you might want to fetch cart count on page load
    // For now, we'll update based on existing elements
    const cartCountElement = document.querySelector('.cart-count');
    if (cartCountElement && !cartCountElement.textContent.trim()) {
        // If cart count is empty, set to 0
        cartCountElement.textContent = '0';
    }
}

// Call this on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCartCountOnLoad();
    
    // Add click handlers to all add-to-cart buttons (for safety)
    document.querySelectorAll('.add-to-cart').forEach(button => {
        if (!button.hasAttribute('data-listener-added')) {
            const productId = button.getAttribute('onclick')?.match(/addToCart\((\d+)\)/)?.[1];
            if (productId) {
                button.setAttribute('data-listener-added', 'true');
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    addToCart(productId);
                });
            }
        }
    });
    
    // Add click handlers to all wishlist buttons (for safety)
    document.querySelectorAll('.wishlist-btn').forEach(button => {
        if (!button.hasAttribute('data-listener-added')) {
            const productId = button.getAttribute('onclick')?.match(/toggleWishlist\(this, (\d+)\)/)?.[1];
            if (productId) {
                button.setAttribute('data-listener-added', 'true');
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    toggleWishlist(this, productId);
                });
            }
        }
    });
});

// Make functions available globally
window.showToast = showToast;
window.toggleWishlist = toggleWishlist;
window.addToCart = addToCart;
window.sortProducts = sortProducts;
window.updateCartCount = updateCartCount;
</script>

{% endblock %}